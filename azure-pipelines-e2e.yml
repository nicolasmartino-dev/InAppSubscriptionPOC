# Mobile MCP E2E Test Pipeline (macOS)
# MVP: Run E2E tests using Android emulator on macOS agent

trigger:
  - main

pool:
  vmImage: 'macos-latest'

stages:
  - stage: BuildAndTest
    displayName: 'Build & E2E Test'
    jobs:
      - job: E2ETest
        displayName: 'Mobile MCP E2E Test'
        timeoutInMinutes: 45
        steps:
          # Setup Java 17
          - task: JavaToolInstaller@0
            displayName: 'Setup Java 17'
            inputs:
              versionSpec: '17'
              jdkArchitectureOption: 'x64'
              jdkSourceOption: 'PreInstalled'

          # Setup Node.js for E2E test script
          - task: NodeTool@0
            displayName: 'Setup Node.js'
            inputs:
              versionSpec: '18.x'

          # Find and setup Android SDK
          - script: |
              echo "=== Finding Android SDK ==="
              # Check common locations
              if [ -n "$ANDROID_HOME" ] && [ -d "$ANDROID_HOME" ]; then
                echo "Found ANDROID_HOME: $ANDROID_HOME"
                export ANDROID_SDK_ROOT="$ANDROID_HOME"
              elif [ -d "$HOME/Library/Android/sdk" ]; then
                export ANDROID_SDK_ROOT="$HOME/Library/Android/sdk"
              elif [ -d "/Users/runner/Library/Android/sdk" ]; then
                export ANDROID_SDK_ROOT="/Users/runner/Library/Android/sdk"
              else
                echo "Android SDK not found, installing..."
                brew install --cask android-commandlinetools
                export ANDROID_SDK_ROOT="$HOME/Library/Android/sdk"
                mkdir -p "$ANDROID_SDK_ROOT"
              fi
              
              echo "Selected ANDROID_SDK_ROOT: $ANDROID_SDK_ROOT"
              
              # Set for future steps as env var
              echo "##vso[task.setvariable variable=ANDROID_SDK_ROOT]$ANDROID_SDK_ROOT"
              
              # List SDK contents
              ls -la "$ANDROID_SDK_ROOT" || echo "SDK directory not accessible yet"
            displayName: 'Setup Android SDK Path'

          # Accept licenses and install components
          - script: |
              echo "=== Installing Android SDK Components ==="
              echo "ANDROID_SDK_ROOT: $ANDROID_SDK_ROOT"
              
              # Find sdkmanager
              SDKMANAGER=""
              if [ -f "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager" ]; then
                SDKMANAGER="$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager"
              elif [ -f "$ANDROID_SDK_ROOT/tools/bin/sdkmanager" ]; then
                SDKMANAGER="$ANDROID_SDK_ROOT/tools/bin/sdkmanager"
              else
                # Try to locate it
                SDKMANAGER=$(find "$ANDROID_SDK_ROOT" -name sdkmanager | head -n 1)
              fi
              
              if [ -n "$SDKMANAGER" ]; then
                echo "Using sdkmanager: $SDKMANAGER"
                yes | "$SDKMANAGER" --licenses || true
                "$SDKMANAGER" "platform-tools" "emulator" "system-images;android-33;google_apis;x86_64" || true
              else
                echo "sdkmanager not found, skipping SDK install"
              fi
            displayName: 'Install SDK Components'
            continueOnError: true

          # Create AVD
          - script: |
              echo "=== Creating AVD ==="
              AVDMANAGER=""
              if [ -f "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/avdmanager" ]; then
                AVDMANAGER="$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/avdmanager"
              elif [ -f "$ANDROID_SDK_ROOT/tools/bin/avdmanager" ]; then
                AVDMANAGER="$ANDROID_SDK_ROOT/tools/bin/avdmanager"
              else
                 AVDMANAGER=$(find "$ANDROID_SDK_ROOT" -name avdmanager | head -n 1)
              fi
              
              if [ -n "$AVDMANAGER" ]; then
                echo "no" | "$AVDMANAGER" create avd -n test_avd -k "system-images;android-33;google_apis;x86_64" --force
              else
                echo "avdmanager not found!"
                exit 1
              fi
            displayName: 'Create AVD'

          # START OPTIMIZATION: Launch emulator first, then build, then wait
          
          # 1. Launch Emulator (Background)
          - script: |
              echo "=== Launching Emulator (Async) ==="
              EMULATOR="$ANDROID_SDK_ROOT/emulator/emulator"
              
              # Start emulator in background
              nohup "$EMULATOR" -avd test_avd -no-window -no-audio -no-boot-anim -no-snapshot -gpu swiftshader_indirect &
              echo "Emulator process started in background."
            displayName: 'Launch Emulator (Async)'

          # 2. Build the app (runs while emulator boots)
          - script: |
              chmod +x ./gradlew
              ./gradlew assembleDebug
            displayName: 'Build Debug APK'

          # 3. Wait for Emulator readiness
          - script: |
              echo "=== Waiting for Emulator to be Ready ==="
              ADB="$ANDROID_SDK_ROOT/platform-tools/adb"
              
              # Wait for device
              "$ADB" wait-for-device
              
              # Wait for boot to complete
              echo "Waiting for emulator to boot..."
              BOOT_COMPLETE=""
              START_TIME=$(date +%s)
              while [ "$BOOT_COMPLETE" != "1" ]; do
                CURRENT_TIME=$(date +%s)
                ELAPSED=$((CURRENT_TIME - START_TIME))
                if [ $ELAPSED -gt 1200 ]; then
                    echo "Timeout waiting for emulator boot"
                    exit 1
                fi
                sleep 5
                BOOT_COMPLETE=$("$ADB" shell getprop sys.boot_completed 2>/dev/null | tr -d '\r')
                echo "Boot status: $BOOT_COMPLETE"
              done
              echo "Emulator is ready (Boot Completed)!"
              
              # Wait for Package Manager to be ready
              echo "Waiting for Package Manager service..."
              PM_READY=""
              START_TIME=$(date +%s)
              while [ "$PM_READY" != "package:/system/framework/framework-res.apk" ]; do
                 CURRENT_TIME=$(date +%s)
                 ELAPSED=$((CURRENT_TIME - START_TIME))
                 if [ $ELAPSED -gt 300 ]; then
                     echo "Timeout waiting for Package Manager"
                     exit 1
                 fi
                 sleep 5
                 PM_READY=$("$ADB" shell pm path android 2>/dev/null | tr -d '\r')
                 echo "PM status: $PM_READY"
              done
              echo "Package Manager is ready!"

              # Reduced sleep time here as we already waited during the build
              sleep 10
            displayName: 'Wait for Emulator'
            timeoutInMinutes: 20

          # Install the app
          - script: |
              "$ANDROID_SDK_ROOT/platform-tools/adb" install app/build/outputs/apk/debug/app-debug.apk
            displayName: 'Install App on Emulator'

          # Launch app
          - script: |
              "$ANDROID_SDK_ROOT/platform-tools/adb" shell am start -n com.subscription.poc/.MainActivity
              sleep 5
            displayName: 'Launch App'

          # Run E2E test
          # Run E2E Test using Mobile MCP
          # --------------------------------------------------------
          - script: |
              echo "=== Running Mobile MCP E2E Test ==="
              cd e2e
              npm install
              # Add platform-tools to PATH for mobile-mcp
              export PATH="$ANDROID_SDK_ROOT/platform-tools:$PATH"
              # In CI, we need to ensure the emulator is fully ready before starting the MCP driver.
              # The previous 'Create and Start Emulator' step puts it in bg, we wait a bit here to be safe.
              sleep 10
              node mcp-driver.js
            displayName: 'Run Mobile MCP E2E Test'

          # Capture screenshot as artifact
          - script: |
              mkdir -p $(Build.ArtifactStagingDirectory)/screenshots
              "$ANDROID_SDK_ROOT/platform-tools/adb" exec-out screencap -p > $(Build.ArtifactStagingDirectory)/screenshots/final_state.png || true
            displayName: 'Capture Final Screenshot'
            condition: always()

          # Publish test artifacts
          - publish: $(Build.ArtifactStagingDirectory)/screenshots
            artifact: e2e-screenshots
            displayName: 'Publish Screenshots'
            condition: always()

          # Cleanup - stop emulator
          - script: |
              "$ANDROID_SDK_ROOT/platform-tools/adb" emu kill || true
            displayName: 'Stop Emulator'
            condition: always()

# Mobile MCP E2E Test Pipeline (macOS)
# MVP: Run E2E tests using Android emulator on macOS agent

trigger:
  - main

pool:
  vmImage: 'macos-latest'

variables:
  ANDROID_SDK_ROOT: '$(HOME)/Library/Android/sdk'

stages:
  - stage: BuildAndTest
    displayName: 'Build & E2E Test'
    jobs:
      - job: E2ETest
        displayName: 'Mobile MCP E2E Test'
        timeoutInMinutes: 45
        steps:
          # Setup Java 17
          - task: JavaToolInstaller@0
            displayName: 'Setup Java 17'
            inputs:
              versionSpec: '17'
              jdkArchitectureOption: 'x64'
              jdkSourceOption: 'PreInstalled'

          # Setup Node.js for E2E test script
          - task: NodeTool@0
            displayName: 'Setup Node.js'
            inputs:
              versionSpec: '18.x'

          # Install Android SDK components
          - script: |
              # Install command line tools if needed
              brew install --cask android-commandlinetools || true
              
              # Accept licenses
              yes | $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager --licenses || true
              
              # Install required components
              $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager "platform-tools" "emulator" "system-images;android-33;google_apis;x86_64"
            displayName: 'Setup Android SDK'
            continueOnError: true

          # Create AVD
          - script: |
              echo "no" | $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/avdmanager create avd \
                -n test_avd \
                -k "system-images;android-33;google_apis;x86_64" \
                --force
            displayName: 'Create AVD'

          # Start Emulator (macOS has hardware acceleration)
          - script: |
              # Start emulator in background
              nohup $ANDROID_SDK_ROOT/emulator/emulator \
                -avd test_avd \
                -no-window \
                -no-audio \
                -no-boot-anim \
                -no-snapshot \
                -gpu host \
                &
              
              # Wait for device
              $ANDROID_SDK_ROOT/platform-tools/adb wait-for-device
              
              # Wait for boot to complete
              echo "Waiting for emulator to boot..."
              while [ "$($ANDROID_SDK_ROOT/platform-tools/adb shell getprop sys.boot_completed 2>/dev/null)" != "1" ]; do
                sleep 5
                echo "Still waiting..."
              done
              echo "Emulator is ready!"
            displayName: 'Start Emulator'
            timeoutInMinutes: 10

          # Build the app
          - script: |
              chmod +x ./gradlew
              ./gradlew assembleDebug
            displayName: 'Build Debug APK'

          # Install the app
          - script: |
              $ANDROID_SDK_ROOT/platform-tools/adb install app/build/outputs/apk/debug/app-debug.apk
            displayName: 'Install App on Emulator'

          # Launch app
          - script: |
              $ANDROID_SDK_ROOT/platform-tools/adb shell am start -n com.subscription.poc/.MainActivity
              sleep 5
            displayName: 'Launch App'

          # Run E2E test
          - script: |
              node $(System.DefaultWorkingDirectory)/e2e/subscription-screen-test.js
            displayName: 'Run E2E Test'
            env:
              ANDROID_SDK_ROOT: $(ANDROID_SDK_ROOT)

          # Capture screenshot as artifact
          - script: |
              mkdir -p $(Build.ArtifactStagingDirectory)/screenshots
              $ANDROID_SDK_ROOT/platform-tools/adb exec-out screencap -p > $(Build.ArtifactStagingDirectory)/screenshots/final_state.png
            displayName: 'Capture Final Screenshot'
            condition: always()

          # Publish test artifacts
          - publish: $(Build.ArtifactStagingDirectory)/screenshots
            artifact: e2e-screenshots
            displayName: 'Publish Screenshots'
            condition: always()

          # Cleanup - stop emulator
          - script: |
              $ANDROID_SDK_ROOT/platform-tools/adb emu kill || true
            displayName: 'Stop Emulator'
            condition: always()
